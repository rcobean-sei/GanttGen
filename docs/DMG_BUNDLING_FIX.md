# DMG Bundling Failure Fix

## Problem Description

The GitHub Actions workflow was failing on macOS ARM64 builds during the DMG creation phase. The workflow run [#20151730894](https://github.com/rcobean-sei/GanttGen/actions/runs/20151730894) showed:

- Rust compilation: ✅ Successful (~4m 13s)
- .app bundle creation: ✅ Successful
- DMG bundling: ❌ Failed with error: `failed to bundle project error running bundle_dmg.sh`

## Root Cause

The DMG creation script (`bundle_dmg.sh`) generated by Tauri uses AppleScript to customize the DMG appearance (window layout, icon positioning, etc.). On GitHub-hosted macOS runners, this fails due to:

1. **AppleScript Permission Issues**: CI runners don't have permissions to send Apple Events to Finder
2. **Common Errors**:
   - "Not authorised to send Apple events to Finder. (-1743)"
   - "AppleEvent timed out. (-1712)"
3. **Non-Interactive Environment**: GitHub Actions runners lack GUI/interactive capabilities needed for AppleScript DMG customization

This is a well-documented limitation of Tauri builds on GitHub Actions macOS runners ([tauri-apps/tauri#3055](https://github.com/tauri-apps/tauri/issues/3055), [tauri-apps/tauri-action#801](https://github.com/tauri-apps/tauri-action/issues/801), [tauri-apps/tauri-action#1003](https://github.com/tauri-apps/tauri-action/issues/1003)).

## Solution Implemented

### For Pull Request Builds

Skip DMG creation entirely and only build the `.app` bundle:

```yaml
- name: Build Tauri app (macOS unsigned for PRs)
  if: matrix.platform == 'macos-latest' && github.event_name == 'pull_request'
  working-directory: tauri-app
  run: |
    echo "Building unsigned app for PR (skipping DMG creation due to GitHub Actions limitations)..."
    npm run tauri build -- --target aarch64-apple-darwin --bundles app
```

The `--bundles app` flag tells Tauri to only create the `.app` bundle and skip DMG creation.

### For Release Builds

Keep the existing behavior (attempt DMG creation) since release builds may benefit from trying:

```yaml
- name: Build Tauri app (macOS with signing)
  if: matrix.platform == 'macos-latest' && github.event_name != 'pull_request'
  working-directory: tauri-app
  run: |
    npm run tauri build -- --target aarch64-apple-darwin
```

**Note**: Release builds may still encounter DMG issues. If this becomes a problem, consider using self-hosted macOS runners or accepting the functional but non-customized DMG output.

### Updated Artifact Handling

Modified the rename step to gracefully handle missing DMG directories:

```yaml
- name: Rename macOS artifacts (non-release)
  if: matrix.platform == 'macos-latest' && steps.check-release.outputs.is_release == 'false'
  run: |
    # Rename DMG files (if they exist - PRs skip DMG creation)
    if [ -d "tauri-app/src-tauri/target/aarch64-apple-darwin/release/bundle/dmg" ]; then
      cd tauri-app/src-tauri/target/aarch64-apple-darwin/release/bundle/dmg
      # ... rename logic ...
    else
      echo "No DMG directory found (skipped for PR builds)"
    fi
    
    # Rename ZIP files (still created from .app bundle)
    if [ -d "tauri-app/src-tauri/target/aarch64-apple-darwin/release/bundle/zip" ]; then
      cd tauri-app/src-tauri/target/aarch64-apple-darwin/release/bundle/zip
      # ... rename logic ...
    fi
```

## What Still Works

1. **macOS .app Bundle**: Still created and fully functional
2. **macOS .zip Bundle**: Created via `scripts/create_mac_zip_bundle.sh` from the .app bundle
3. **Windows Builds**: Completely unaffected, continue to produce .exe and .msi
4. **Release Builds**: Still attempt DMG creation (may succeed or produce functional DMG despite errors)

## Distribution Options for macOS

Users can still install GanttGen on macOS via:

1. **.app Bundle**: Direct download from CI artifacts
2. **.zip Bundle**: Contains .app, helper script, and Applications alias for easy drag-and-drop installation
3. **DMG (Release builds only)**: If DMG creation succeeds, this provides the traditional disk image installer

## Alternative Solutions Considered

1. **Use Self-Hosted macOS Runner**: Would solve the problem but requires infrastructure
2. **Disable DMG Globally**: Would affect release builds that might benefit from DMG
3. **Accept Partial Failures**: DMG might still be created despite errors, but less reliable
4. **Manual DMG Creation**: Post-process locally, not automatable in CI

## Testing

To verify the fix works:

1. Create a PR with this change
2. Workflow should succeed for macOS ARM64 build
3. Artifacts should contain:
   - GanttGen.app (via .zip bundle)
   - No DMG file for PR builds
4. Windows build should remain unaffected

## References

- [Tauri Issue #3055: bundle_dmg.sh fails](https://github.com/tauri-apps/tauri/issues/3055)
- [Tauri Action Issue #801: bundle_dmg.sh error](https://github.com/tauri-apps/tauri-action/issues/801)
- [Tauri Action Issue #1003: Error running bundle_dmg.sh](https://github.com/tauri-apps/tauri-action/issues/1003)
- [Stack Overflow: Tauri/Angular App for MacOS](https://stackoverflow.com/questions/78679317/tauri-angular-app-for-macos-after-adding-signing-running-bash-script-shuts-do)

## Memory for Future Reference

This fix should be remembered for:
- Future workflow modifications
- When adding new build targets
- When troubleshooting similar bundling issues
- When considering DMG customization requirements
