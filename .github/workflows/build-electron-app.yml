name: Build Electron App

on:
  push:
    branches:
      - 'claude/electron-installer-app-*'
      - 'main'
    tags:
      - 'v*'
  pull_request:
    paths:
      - 'electron-app/**'
      - '.github/workflows/build-electron-app.yml'
  workflow_dispatch:

jobs:
  build:
    name: Build for ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: mac
            arch: arm64
          - os: windows-latest
            platform: win
            arch: x64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            electron-app/package-lock.json

      - name: Install root dependencies
        run: npm ci --legacy-peer-deps || npm install --legacy-peer-deps

      - name: Install Electron app dependencies
        working-directory: electron-app
        run: npm ci

      - name: Install Playwright browsers (for PNG export)
        working-directory: electron-app
        run: npx playwright install --with-deps chromium
        continue-on-error: true

      - name: Verify dependencies installed
        shell: bash
        run: |
          echo "=== Verifying dependencies ==="
          if [ ! -d "node_modules" ]; then
            echo "ERROR: Root node_modules not found!"
            exit 1
          fi
          echo "✓ Root node_modules exists"

          if [ ! -d "node_modules/exceljs" ]; then
            echo "ERROR: exceljs not found in root node_modules!"
            exit 1
          fi
          echo "✓ exceljs found"

          if [ ! -d "electron-app/node_modules" ]; then
            echo "ERROR: Electron app node_modules not found!"
            exit 1
          fi
          echo "✓ Electron app node_modules exists"
          echo "=== Dependencies verification passed ==="

      - name: Import Apple Developer Certificate
        if: matrix.platform == 'mac' && github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main')
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        run: |
          # Create certificate file from base64 secret
          echo $MACOS_CERTIFICATE | base64 --decode > certificate.p12

          # Create temporary keychain
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain

          # Import certificate to keychain
          security import certificate.p12 -k build.keychain -P $MACOS_CERTIFICATE_PWD -T /usr/bin/codesign

          # Allow codesign to access keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain

          # Clean up certificate file
          rm certificate.p12

          echo "Certificate imported successfully"

      - name: Build Electron app (macOS)
        if: matrix.platform == 'mac'
        working-directory: electron-app
        env:
          # Code signing (only on releases or main branch)
          CSC_LINK: ${{ github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main') && secrets.MACOS_CERTIFICATE || '' }}
          CSC_KEY_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          # Notarization (only on releases or main branch)
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: npm run build:mac

      - name: Build Electron app (Windows)
        if: matrix.platform == 'win'
        working-directory: electron-app
        run: npm run build:win

      - name: List build artifacts
        working-directory: electron-app
        shell: bash
        run: |
          echo "Build completed. Contents of dist directory:"
          ls -lah dist/ || echo "No dist directory found"
          if [ -d "dist" ]; then
            find dist -type f -name "*.dmg" -o -name "*.zip" -o -name "*.exe" || echo "No installers found"
          fi

      - name: Verify macOS build
        if: matrix.platform == 'mac'
        working-directory: electron-app
        shell: bash
        run: |
          echo "=== Verifying macOS build ==="

          # Show what's actually in dist
          echo "Contents of dist directory:"
          ls -laR dist/ || echo "dist directory not found"
          echo ""

          # Check if .app bundle exists
          APP_PATH=$(find dist -name "GanttGen.app" -type d 2>/dev/null | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "ERROR: GanttGen.app not found!"
            echo "Searched for: GanttGen.app in dist/"
            exit 1
          fi
          echo "✓ Found app bundle: $APP_PATH"

          # Check app structure
          if [ ! -f "$APP_PATH/Contents/MacOS/GanttGen" ]; then
            echo "ERROR: Main executable not found!"
            exit 1
          fi
          echo "✓ Main executable exists"

          # Check Info.plist
          if [ ! -f "$APP_PATH/Contents/Info.plist" ]; then
            echo "ERROR: Info.plist not found!"
            exit 1
          fi
          echo "✓ Info.plist exists"

          # Verify architecture
          ARCH=$(file "$APP_PATH/Contents/MacOS/GanttGen" | grep -o "arm64\|x86_64")
          echo "Architecture: $ARCH"
          if [[ "$ARCH" != *"arm64"* ]]; then
            echo "WARNING: Expected arm64 architecture"
          fi

          # Check DMG exists
          DMG_COUNT=$(find dist -name "*.dmg" | wc -l)
          if [ "$DMG_COUNT" -eq 0 ]; then
            echo "ERROR: No DMG file found!"
            exit 1
          fi
          echo "✓ DMG file(s) found: $DMG_COUNT"

          # Check ZIP exists
          ZIP_COUNT=$(find dist -name "*.zip" | wc -l)
          if [ "$ZIP_COUNT" -eq 0 ]; then
            echo "ERROR: No ZIP file found!"
            exit 1
          fi
          echo "✓ ZIP file(s) found: $ZIP_COUNT"

          echo "=== macOS build verification passed ==="

      - name: Verify Windows build
        if: matrix.platform == 'win'
        working-directory: electron-app
        shell: bash
        run: |
          echo "=== Verifying Windows build ==="

          # Check if unpacked app exists
          if [ ! -d "dist/win-unpacked" ]; then
            echo "ERROR: win-unpacked directory not found!"
            exit 1
          fi
          echo "✓ Found unpacked directory"

          # Check main executable
          if [ ! -f "dist/win-unpacked/GanttGen.exe" ]; then
            echo "ERROR: GanttGen.exe not found in unpacked directory!"
            exit 1
          fi
          echo "✓ Main executable exists"

          # Check installer exists
          INSTALLER_COUNT=$(find dist -name "*Setup*.exe" | wc -l)
          if [ "$INSTALLER_COUNT" -eq 0 ]; then
            echo "ERROR: No installer found!"
            exit 1
          fi
          echo "✓ Installer(s) found: $INSTALLER_COUNT"

          # Check portable exe exists
          PORTABLE_COUNT=$(find dist -name "*.exe" ! -name "*Setup*.exe" | wc -l)
          if [ "$PORTABLE_COUNT" -eq 0 ]; then
            echo "WARNING: No portable exe found"
          else
            echo "✓ Portable exe(s) found: $PORTABLE_COUNT"
          fi

          echo "=== Windows build verification passed ==="

      - name: Upload macOS DMG
        if: matrix.platform == 'mac'
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: electron-app/dist/*.dmg
          if-no-files-found: warn
          retention-days: 30

      - name: Upload macOS ZIP
        if: matrix.platform == 'mac'
        uses: actions/upload-artifact@v4
        with:
          name: macos-zip
          path: electron-app/dist/*.zip
          if-no-files-found: warn
          retention-days: 30

      - name: Upload Windows Installer
        if: matrix.platform == 'win'
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: electron-app/dist/*.exe
          if-no-files-found: warn
          retention-days: 30

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.platform }}
          path: |
            electron-app/dist/*.log
            electron-app/*.log
          if-no-files-found: ignore
          retention-days: 7

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Display structure of downloaded files
        run: |
          echo "Downloaded artifacts:"
          ls -lhR release-artifacts/

      - name: Prepare release files
        run: |
          mkdir -p release-files
          find release-artifacts -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.exe" \) -exec cp {} release-files/ \;
          echo "Files prepared for release:"
          ls -lh release-files/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-files/*
          draft: true
          generate_release_notes: true
          name: GanttGen Electron v${{ github.ref_name }}
          body: |
            ## GanttGen Electron Desktop App

            Cross-platform desktop application for generating professional Gantt charts.

            ### Downloads

            **macOS (Apple Silicon only):**
            - `.dmg` - Disk image installer (recommended)
            - `.zip` - Zip archive
            - Requires macOS 11.0+ on Apple Silicon (M1/M2/M3/M4)

            **Windows:**
            - `Setup.exe` - NSIS installer (recommended)
            - Portable `.exe` - Standalone executable
            - Requires Windows 10+ (64-bit)

            ### Installation Notes

            **macOS:**
            - Apps are code-signed and notarized
            - Double-click the DMG to install
            - Drag GanttGen to Applications folder
            - Requires macOS 11.0+ on Apple Silicon (M1/M2/M3/M4)

            **Windows:**
            - Apps are not code-signed (may trigger SmartScreen)
            - Click "More info" → "Run anyway" if prompted
            - Requires Windows 10+ (64-bit)

            ### Verification

            All builds are automatically verified for:
            - ✅ App bundle/executable structure
            - ✅ Required files present
            - ✅ Correct architecture (arm64 for macOS, x64 for Windows)
            - ✅ Installer files generated

            ### Documentation

            - [README](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/electron-app/README.md)
            - [Building Guide](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/electron-app/BUILDING.md)
            - [Release Notes](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/electron-app/RELEASE_NOTES.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
